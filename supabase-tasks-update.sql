-- ============================================
-- Обновление для функционала задач
-- ============================================
-- ВАЖНО: Сначала проверьте, что все политики уже существуют
-- Выполните этот скрипт только если что-то не работает

-- 1. Убеждаемся, что политика для specialists позволяет всем просматривать
-- (нужно для JOIN в запросах откликов)
DROP POLICY IF EXISTS "Все могут просматривать профили специалистов" ON specialists;
CREATE POLICY "Все могут просматривать профили специалистов"
  ON specialists FOR SELECT
  USING (true);

-- 2. Убеждаемся, что политика для applications позволяет компаниям
-- просматривать заявки на свои проекты
DROP POLICY IF EXISTS "Компании могут просматривать заявки на свои проекты" ON applications;
CREATE POLICY "Компании могут просматривать заявки на свои проекты"
  ON applications FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM projects
      WHERE projects.id = applications.project_id
      AND projects.company_id = auth.uid()
    )
  );

-- 3. Убеждаемся, что политика для projects позволяет компаниям
-- просматривать все свои проекты (не только открытые)
-- Это нужно для категории "Мои проекты"
DROP POLICY IF EXISTS "Компании могут просматривать свои проекты" ON projects;
CREATE POLICY "Компании могут просматривать свои проекты"
  ON projects FOR SELECT
  USING (auth.uid() = company_id);

-- ============================================
-- Готово!
-- ============================================
-- После выполнения этого скрипта все должно работать корректно

